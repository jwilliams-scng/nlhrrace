<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SCNG • NL Home Run Race</title>
<style>
  :root { color-scheme: light only; }
  html,body{margin:0;padding:0}
  body{
    padding:12px 12px 0;
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:#fff; overflow-x:hidden;
  }
  .wrap{max-width:740px;margin:0 auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(90deg,var(--p,#0d47a1),var(--a,#1976d2));color:#fff}
  header h3{margin:0;font-size:16px;letter-spacing:.2px;font-weight:800}
  header .meta{font-size:12px;opacity:.95}
  .diag{font-size:12px;background:#fff8c5;border:1px solid #fde68a;color:#7c3e11;border-radius:10px;padding:6px 10px;margin:8px 12px}
  .body{padding:12px}.body>:last-child{margin-bottom:0}
  .note{font-size:12px;color:#6b7280;margin:6px 0 12px}
  .race{padding:6px 0 12px}
  .race .labels{display:flex;justify-content:space-between;font-size:13px}
  .race .bar{height:10px;background:#e5e7eb;border-radius:999px;position:relative;overflow:hidden;margin:6px 0}
  .race .fill{position:absolute;top:0;bottom:0;width:50%;background:#fff;opacity:.7;transition:width .3s ease}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;border-bottom:1px solid #e5e7eb}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #e5e7eb;vertical-align:middle;white-space:nowrap}
  tbody tr:last-child td{border-bottom:0}
  th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;background:#fafafa;position:sticky;top:0}
  tbody tr:nth-child(even){background:#f6f7f9}
  tbody tr.leader{background:#fff7cc}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  @media (max-width:480px){th.hide-sm,td.hide-sm{display:none}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h3>NL Home Run Race</h3>
      <div class="meta"></div>
    </header>

    <div id="diag" class="diag" style="display:none"></div>

    <div class="body">
      <div class="race">
        <div class="labels"><div id="l1"></div><div id="l2"></div></div>
        <div class="bar"><div class="fill" id="bar"></div></div>
        <div class="labels"><div id="lead"></div><div>Regular season • NL</div></div>
      </div>

      <table aria-label="NL home run leaders">
        <thead>
          <tr>
            <th>#</th><th>Player</th><th>Team</th>
            <th class="num">HR</th><th class="num hide-sm">RBI</th><th class="num hide-sm">AB</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="6" class="note">Loading leaders…</td></tr></tbody>
      </table>

      <div class="note" id="asof"></div>
    </div>
  </div>
</div>

<script>
(async () => {
  /* ---------- Branding ---------- */
  const brandMap={ 'dailynews.com':'ladn','ocregister.com':'ocr','sgvtribune.com':'sgv','dailybreeze.com':'db','presstelegram.com':'pt','sbsun.com':'sbs','dailybulletin.com':'ivdb','pasadenastarnews.com':'psn','whittierdailynews.com':'wdn','dailypilot.com':'dp' };
  const brandColors={ ladn:['#0d47a1','#1976d2'],ocr:['#0b3d91','#1e88e5'],sgv:['#334155','#64748b'],db:['#0f766e','#14b8a6'],pt:['#1f2937','#4b5563'],sbs:['#7c2d12','#ea580c'],ivdb:['#3b0764','#7c3aed'],psn:['#111827','#374151'],wdn:['#27272a','#52525b'],dp:['#1e3a8a','#2563eb'],default:['#0d47a1','#1976d2'] };
  const qs=new URLSearchParams(location.search); const force=(qs.get('brand')||'').toLowerCase();
  let host=''; try{host=new URL(document.referrer).hostname.toLowerCase().replace(/^www\./,'');}catch(e){}
  const [p,a]=(brandColors[force||brandMap[host]||'default']||brandColors.default); document.documentElement.style.setProperty('--p',p); document.documentElement.style.setProperty('--a',a);

  /* ---------- Meta ---------- */
  const meta=document.querySelector('.meta'); const now=new Date(); const season=(now.getUTCMonth()+1)<=2?now.getUTCFullYear()-1:now.getUTCFullYear();
  meta.textContent=`${season} • Updated ${now.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'})}`;

  /* ---------- Elements ---------- */
  const rowsEl=document.getElementById('rows'), l1=document.getElementById('l1'), l2=document.getElementById('l2'), bar=document.getElementById('bar'), leadEl=document.getElementById('lead'), asofEl=document.getElementById('asof'), diagEl=document.getElementById('diag');
  function log(msg){ diagEl.style.display='block'; diagEl.textContent+=(diagEl.textContent?' • ':'Diag: ')+msg; }

  const TEAM={108:'LAA',109:'ARI',110:'BAL',111:'BOS',112:'CHC',113:'CIN',114:'CLE',115:'COL',116:'DET',117:'HOU',118:'KC',119:'LAD',120:'WSH',121:'NYM',133:'OAK',134:'PIT',135:'SD',136:'SEA',137:'SF',138:'STL',139:'TB',140:'TEX',141:'TOR',142:'MIN',143:'PHI',144:'ATL',145:'CWS',146:'MIA',147:'NYY',158:'MIL'};
  const NL=new Set([109,144,112,113,115,119,146,158,121,143,134,135,137,138,120]);
  const int0=n=>isFinite(n)?Number(n).toFixed(0):'—';

  async function tryJSON(url,label){
    try{ const r=await fetch(url,{mode:'cors',cache:'no-store'}); log(`${label}:${r.status}`); if(r.ok) return await r.json(); }catch(e){ log(`${label}:ERR`); }
    return null;
  }
  async function fetchTextProxy(url,label){
    try{
      const prox = `https://r.jina.ai/http://${url.replace(/^https?:\/\//,'')}`;
      const r = await fetch(prox,{mode:'cors',cache:'no-store'});
      const t = await r.text(); log(`${label}:ok(text)`);
      return t;
    }catch(e){ log(`${label}:ERR`); return null; }
  }

  /* ---------- Attempt 1: StatsAPI leagueLeaders (if your network ever allows it) ---------- */
  let leaders = [];
  {
    const j = await tryJSON(`https://statsapi.mlb.com/api/v1/leagueLeaders?leaderCategories=homeRuns&season=${season}&leaderGameTypes=R&leagueId=104&limit=50&hydrate=person,team`,'leadersNL');
    if (j) {
      const arr = j?.leagueLeaders?.[0]?.leaders || [];
      if (arr.length) {
        leaders = arr.map(x=>({ name:x?.person?.fullName||'', teamId:x?.team?.id, team:TEAM[x?.team?.id]||x?.team?.abbreviation||x?.team?.teamCode||'', hr:+x?.value||0, rbi:+x?.rbi||0, ab:+x?.atBats||0 }));
      }
    }
  }

  /* ---------- Attempt 2: Parse mlb.com/stats HTML (__NEXT_DATA__) via text proxy ---------- */
  if (!leaders.length) {
    const url = `https://www.mlb.com/stats/home-runs?league=nl&gameType=R&season=${season}`;
    const html = await fetchTextProxy(url,'mlb.com stats page');
    if (html) {
      // Grab the embedded Next.js JSON
      const m = html.match(/<script id="__NEXT_DATA__" type="application\/json">([\s\S]*?)<\/script>/);
      if (m) {
        try {
          const data = JSON.parse(m[1]);
          // Deep-search for an array of player objects with HR & name
          let list = [];
          (function walk(x){
            if (Array.isArray(x)) {
              if (x.length && typeof x[0]==='object' && (('hr' in x[0]) || ('homeRuns' in x[0])) ) { list = x; return; }
              for (const v of x) walk(v);
            } else if (x && typeof x==='object') {
              for (const k in x) { if (list.length) break; walk(x[k]); }
            }
          })(data);

          if (list.length) {
            leaders = list.map(it=>{
              const name = it.fullName || it.playerFullName || it.firstLastName || it.playerName || it.name || '';
              const hr   = +(it.hr ?? it.homeRuns ?? it.HR ?? 0);
              const rbi  = +(it.rbi ?? it.RBI ?? 0);
              const ab   = +(it.ab ?? it.AB ?? 0);
              const team = it.teamAbbrev || it.teamAbbreviation || it.teamShortName || it.team || '';
              return { name, team, hr, rbi, ab };
            }).filter(x=>x.name && Number.isFinite(x.hr));

            // Sometimes the page returns MLB; filter to NL if we can infer league
            // (we accept as-is if no league hints are present)
          }
          log(`mlb.com __NEXT_DATA__: ${leaders.length} rows`);
        } catch(e){ log('mlb.com JSON parse:ERR'); }
      } else {
        log('__NEXT_DATA__ not found');
      }
    }
  }

  /* ---------- Attempt 3: StatsAPI generic (if allowed) ---------- */
  if (!leaders.length) {
    const j = await tryJSON(`https://statsapi.mlb.com/api/v1/stats?stats=season&group=hitting&season=${season}&sportId=1&gameType=R&order=desc&sortStat=homeRuns&limit=400`,'statsAll');
    if (j) {
      const s = j?.stats?.[0]?.splits || [];
      leaders = s
        .filter(x => NL.has(x?.team?.id || x?.player?.currentTeam?.id || x?.person?.currentTeam?.id))
        .map(x=>{
          const st = x?.stat || {};
          const tid = x?.team?.id || x?.player?.currentTeam?.id || x?.person?.currentTeam?.id;
          const team = TEAM[tid] || x?.team?.abbreviation || x?.team?.teamCode || '';
          const name = x?.player?.fullName || x?.person?.fullName || '';
          return { name, team, hr:+st?.homeRuns||0, rbi:+st?.rbi||0, ab:+st?.atBats||0 };
        });
      log(`statsAll rows:${leaders.length}`);
    }
  }

  /* ---------- Render ---------- */
  leaders.sort((a,b)=>(b.hr-a.hr)||(b.rbi-a.rbi)||(b.ab-a.ab));
  leaders = leaders.slice(0,10);

  if (!leaders.length) {
    rowsEl.innerHTML = `<tr><td colspan="6" class="note">Leaders temporarily unavailable.</td></tr>`;
    return;
  }

  const [one,two] = leaders;
  l1.textContent = `${one.name.split(' ').slice(-1)[0]} ${int0(one.hr)}`;
  l2.textContent = `#2 ${int0(two.hr)}`;
  const diff = one.hr - two.hr;
  bar.style.width = (50 + Math.max(-6, Math.min(6, diff)) * 5) + '%';
  leadEl.textContent = `Lead: ${int0(diff)} HR`;

  rowsEl.innerHTML = leaders.map((r,i)=>`
    <tr class="${i===0?'leader':''}">
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.team||''}</td>
      <td class="num">${int0(r.hr)}</td>
      <td class="num hide-sm">${int0(r.rbi)}</td>
      <td class="num hide-sm">${int0(r.ab)}</td>
    </tr>
  `).join('');

  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||'America/Los_Angeles';
  const fmt=new Intl.DateTimeFormat('en-US',{dateStyle:'medium',timeStyle:'short',timeZone:tz});
  asofEl.textContent=`As of ${fmt.format(now)} • Regular season • NL`;
})();
</script>
</body>
</html>
